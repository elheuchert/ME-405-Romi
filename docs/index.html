<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ME 405 Romi: ME405 Library Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ME 405 Romi
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ME405 Library Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="intro"></a>
Introduction</h1>
<p>Our goal for this project was to run and tune our Romi robot so that it could follow a course provided by our instructor. To achieve autonomous navigation, we used many sensor systems, starting with quadrature encoders that provided motor feedback for control through PD control. Reflectance sensors enabled us to detect lines on the track surface, allowing for line-following. The IMU supplied orientation data for state estimation and heading correction. A Bluetooth module allowed for wireless data transfer, helpful for running tests. Finally, Bump sensors provided collision detection for obstacle detection.</p>
<p>This Documentation includes information about:</p><ul>
<li>Hardware</li>
<li>Software architecture<ul>
<li>Namespaces</li>
<li>Classes</li>
<li>Task information</li>
</ul>
</li>
<li>Test results and performance</li>
<li>Key takeaways</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="hardware"></a>
Hardware</h1>
<h2 class="doxsection"><a class="anchor" id="motors"></a>
Motors</h2>
<p>We used Romi, which has two H-bridge motor drivers.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Motor Enable Left  </td><td class="markdownTableBodyNone">PA10  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Motor Direction Left  </td><td class="markdownTableBodyNone">PB10  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Motor Effort Left  </td><td class="markdownTableBodyNone">PB6  </td><td class="markdownTableBodyNone">TIM4_CH1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Motor Enable Right  </td><td class="markdownTableBodyNone">PC14  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Motor Direction Right  </td><td class="markdownTableBodyNone">PC13  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Motor Effort Right  </td><td class="markdownTableBodyNone">PB7  </td><td class="markdownTableBodyNone">TIM4_CH2  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="encoders"></a>
Encoders</h2>
<p>We used Romi, which has two encoders for their respective motors, allowing us to perform motor control.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Encoder Left 1  </td><td class="markdownTableBodyNone">PA0  </td><td class="markdownTableBodyNone">TIM2_CH1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Encoder Left 2  </td><td class="markdownTableBodyNone">PA1  </td><td class="markdownTableBodyNone">TIM2_CH2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Encoder Right 1  </td><td class="markdownTableBodyNone">PC6  </td><td class="markdownTableBodyNone">TIM3_CH1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Encoder Right 2  </td><td class="markdownTableBodyNone">PC7  </td><td class="markdownTableBodyNone">TIM3_CH2  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="bluetooth"></a>
Bluetooth</h2>
<p>We used a bluetooth module to send user instructions, as well as receive data for various tests, including step response tests. We attached this to the top of our Romi robit.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">5v  </td><td class="markdownTableBodyNone">E5v  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">UART Tx  </td><td class="markdownTableBodyNone">C12  </td><td class="markdownTableBodyNone">UART5_TX  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">UART Rx  </td><td class="markdownTableBodyNone">D12  </td><td class="markdownTableBodyNone">UART5_RX  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="imu"></a>
IMU</h2>
<p>We used a adafruit bno055, which we configured to IMU mode. This allowed us to things like yaw, pitch, roll and angular velocity. We attached this to the bottom of the Romi robot.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">IMU  </td><td class="markdownTableBodyNone">PB9  </td><td class="markdownTableBodyNone">SDA  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">IMU  </td><td class="markdownTableBodyNone">PB8  </td><td class="markdownTableBodyNone">SCL  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">IMU REST  </td><td class="markdownTableBodyNone">PC8  </td><td class="markdownTableBodyNone">REST  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="linesensor"></a>
Line Sensors</h2>
<p>We used a 13 channel reflectance sensor array, with analog output. This allows us to read a line, which we can then use make our Romi robot follow a line. We attached this using 3D printed supports to the front of the robot.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 1  </td><td class="markdownTableBodyNone">PA6  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 2  </td><td class="markdownTableBodyNone">PA7  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 3  </td><td class="markdownTableBodyNone">PC4  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 4  </td><td class="markdownTableBodyNone">PA0  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 5  </td><td class="markdownTableBodyNone">PA1  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 6  </td><td class="markdownTableBodyNone">PA4  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 7  </td><td class="markdownTableBodyNone">PB0  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 8  </td><td class="markdownTableBodyNone">PC1  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 9  </td><td class="markdownTableBodyNone">PC0  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 10  </td><td class="markdownTableBodyNone">PC2  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 11  </td><td class="markdownTableBodyNone">PC3  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Analog Pin 12  </td><td class="markdownTableBodyNone">PC5  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog Pin 13  </td><td class="markdownTableBodyNone">PB1  </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">VCC  </td><td class="markdownTableBodyNone">5v  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CTRL EVN  </td><td class="markdownTableBodyNone">PH1  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CTRL ODD  </td><td class="markdownTableBodyNone">PH0  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="bump"></a>
Bump Sensors</h2>
<p>We used bump sensors made for Romi, using both left and right modules. These bump sensors are used to detect collision, which will tell Romi the next steps. We attached these to the front of the Romi robot.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Pin Selection  </th><th class="markdownTableHeadNone">Function  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Bump 0  </td><td class="markdownTableBodyNone">PA12  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bump 1  </td><td class="markdownTableBodyNone">PA11  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Bump 2  </td><td class="markdownTableBodyNone">PB12  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bump 3  </td><td class="markdownTableBodyNone">PB11  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Bump 4  </td><td class="markdownTableBodyNone">PB15  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bump 5  </td><td class="markdownTableBodyNone">PB14  </td><td class="markdownTableBodyNone">GPIO  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">GND  </td><td class="markdownTableBodyNone">-  </td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="results"></a>
Test Results and Performance</h1>
<h2 class="doxsection"><a class="anchor" id="test"></a>
Test Results</h2>
<p><b>Velocity Plots testing</b></p>
<p>After pressing the go command “s”, we have the Romi go through 4 tests, each consisting of 10 step response tests. Those 4 tests are velocity for the left and right motor, and position for the left and right motor. These data points are automatically given to the user when running the PC script and plotted accordingly. The results are shown below in Figures 1-4.</p>
<div class="image">
<img src="Plot_1.png" alt=""/>
</div>
<p> Figure 1. Left Motor Velocity Step Response </p><div class="image">
<img src="Plot_2.png" alt=""/>
</div>
<p> Figure 2. Right Motor Velocity Step Response </p><div class="image">
<img src="Plot_3.png" alt=""/>
</div>
<p> Figure 3. Left Motor Position Step Response </p><div class="image">
<img src="Plot_4.png" alt=""/>
</div>
<p> Figure 4. Right Motor Position Step Response</p>
<p>Based on these velocity graphs, it seems that our chosen frequencies were sufficient as it portrays a step response. Using the CSV files we obtained, we can then generate a time constant for both the left and right motors for the control theory task to be applied next week.</p>
<p><b>Closed Loop Control Testing</b></p>
<p>To tune Romi’s performance, we used our automatic data collection to run driving forward tests via our PC script. We started with only proportional control, running the motor at 200 mm/s, with K_P being the same for both motors, with Figure 5 being our first test. The next tests with Figures 6-7 are tests where we changed the Kp values, resulting in Figure 7, where we found a sufficient Kp value for this test period.</p>
<div class="image">
<img src="Plot_5.png" alt=""/>
</div>
<p> Figure 5. Velocity of both motors with Kpr = 0.25 and Kpl = 0.25 </p><div class="image">
<img src="Plot_6.png" alt=""/>
</div>
<p> Figure 6. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15 </p><div class="image">
<img src="Plot_7.png" alt=""/>
</div>
<p> Figure 7. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15 and Vref = 300 mm/s</p>
<p>After obtaining a relatively sufficient Kp, next we included integral control, controlling the Kp and Ki. Implementing both started of beneficial, as seen in Figure 8. We then raised Ki, in the next two Figures, 9 and 10, but it behaved erratically. Seeing as it was too much gain, we lowered Ki, but it still behaved erratically, so we were unsure where to continue from there.</p>
<div class="image">
<img src="Plot_8.png" alt=""/>
</div>
<p> Figure 8. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15, Kir = 0.5 and Kil = 0.5 </p><div class="image">
<img src="Plot_9.png" alt=""/>
</div>
<p> Figure 9. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15, Kir = 2 and Kil = 2 </p><div class="image">
<img src="Plot_10.png" alt=""/>
</div>
<p> Figure 10. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15, Kir = 2.5 and Kil = 2.5 </p><div class="image">
<img src="Plot_11.png" alt=""/>
</div>
<p> Figure 11. Velocity of both motors with Kpr = 0.1 and Kpl = 0.15, Kir = 2.1 and Kil = 2.1</p>
<h2 class="doxsection"><a class="anchor" id="performance"></a>
Track Performance</h2>
<h1 class="doxsection"><a class="anchor" id="key"></a>
Key takeaways</h1>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
